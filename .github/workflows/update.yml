name: Auto Update

on:
  schedule:
    - cron: '0 * * * *'  # Hourly
  workflow_dispatch:      # Manual trigger

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27

      - name: Install jq (for version extraction)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run update script
        id: update
        run: |
          ./scripts/update.sh

          # Capture outputs from the script (it echoes messages)
          if git diff --quiet versions.json; then
            echo "needs_update=false" >> $GITHUB_OUTPUT
          else
            echo "needs_update=true" >> $GITHUB_OUTPUT
            NEW_VERSION=$(jq -r '.passCliVersions.version' versions.json)
            echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Test build (on update)
        if: steps.update.outputs.needs_update == 'true'
        run: |
          nix build .#proton-pass-cli --print-build-logs

      - name: Commit and push (on update)
        if: steps.update.outputs.needs_update == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add versions.json
          git commit -m "proton-pass-cli: update to ${{ steps.update.outputs.new_version }}"
          git push

      - name: Create Release (on update)
        if: steps.update.outputs.needs_update == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "v${{ steps.update.outputs.new_version }}" \
            --title "proton-pass-cli ${{ steps.update.outputs.new_version }}" \
            --generate-notes
